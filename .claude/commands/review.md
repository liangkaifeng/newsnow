---
description: 全面审查代码质量、性能和安全性
---

执行全面的代码审查，检查以下方面：

## 1. 代码质量 📝

### 类型安全
- [ ] 所有函数有明确的类型注解
- [ ] 没有使用 `any` 类型（除非必要）
- [ ] Props 和 State 类型定义完整
- [ ] API 响应有类型定义（Zod schema）

### 代码规范
- [ ] 符合 ESLint 规则
- [ ] 变量命名清晰有意义
- [ ] 函数职责单一（SOLID 原则）
- [ ] 复杂逻辑有注释说明
- [ ] 没有重复代码（DRY 原则）

### 可维护性
- [ ] 组件拆分合理（单一职责）
- [ ] 工具函数可复用
- [ ] 魔法数字提取为常量
- [ ] 配置项集中管理

## 2. 性能优化 ⚡

### 前端性能
- [ ] 使用 React.memo() 避免不必要渲染
- [ ] 使用 useMemo/useCallback 优化计算
- [ ] 图片懒加载
- [ ] 路由代码分割
- [ ] TanStack Query 缓存配置合理

### 网络性能
- [ ] API 响应时间 < 500ms
- [ ] 使用 Cloudflare KV 缓存
- [ ] 批量请求合并
- [ ] 分页加载（避免一次性加载大量数据）

### 运行性能
- [ ] Lighthouse Performance > 90
- [ ] 首屏加载 < 2s
- [ ] 交互响应 < 100ms
- [ ] 列表虚拟滚动（如果数据量大）

## 3. 安全性 🔒

### 常见漏洞检查
- [ ] XSS 防护（输入过滤、输出转义）
- [ ] SQL 注入防护（使用参数化查询）
- [ ] CSRF 防护（Token 验证）
- [ ] 敏感信息保护（不暴露密钥）
- [ ] 速率限制（防止滥用）

### 认证授权
- [ ] JWT 过期时间合理（30 天）
- [ ] Token 存储安全（httpOnly cookie 或 localStorage）
- [ ] 权限验证完整（前端 + 后端）
- [ ] 会话管理安全

### 数据保护
- [ ] 用户邮箱脱敏显示
- [ ] 敏感数据加密存储
- [ ] HTTPS 强制使用
- [ ] CORS 正确配置

## 4. 用户体验 🎨

### 交互设计
- [ ] 加载状态显示（骨架屏、Spinner）
- [ ] 错误提示清晰友好
- [ ] 成功反馈及时
- [ ] 表单验证实时反馈
- [ ] 操作可撤销（如投票）

### 响应式设计
- [ ] 移动端布局正常（375px 宽度）
- [ ] 平板端布局正常（768px 宽度）
- [ ] 桌面端布局正常（1280px+ 宽度）
- [ ] 触摸友好（按钮大小足够）

### 无障碍访问
- [ ] 语义化 HTML（正确使用 h1-h6、article、nav）
- [ ] 键盘导航支持（Tab、Enter、Esc）
- [ ] ARIA 标签（role、aria-label）
- [ ] 对比度符合 WCAG 2.1 AA 标准

## 5. 测试覆盖 ✅

### E2E 测试
- [ ] 核心功能有 E2E 测试覆盖
- [ ] 测试用例通过率 100%
- [ ] 测试场景覆盖主要用户路径
- [ ] 边界情况测试（空数据、错误状态）

### 单元测试
- [ ] 工具函数有单元测试
- [ ] 复杂逻辑有单元测试
- [ ] 测试覆盖率 > 80%（核心模块）

## 6. 成本控制 💰

### 资源使用
- [ ] Cloudflare 请求量在免费额度内（< 100k/天）
- [ ] D1 读写在免费额度内（< 100k 读/天）
- [ ] 图片使用 WebP 格式（减少带宽）
- [ ] 静态资源 CDN 缓存

### AI 成本
- [ ] AI 调用有限流（每用户每天最多 5 次）
- [ ] 优先使用 Haiku（便宜）而非 Sonnet
- [ ] 缓存 AI 生成结果（24 小时）
- [ ] 避免重复调用

## 7. 文档完整性 📚

### 代码文档
- [ ] README.md 更新（新功能说明）
- [ ] API 文档更新（端点、参数、响应）
- [ ] 组件文档更新（Props、使用示例）
- [ ] E2E 测试文档更新

### Spec 文档
- [ ] .specs/ 目录中有对应规格文档
- [ ] 实施计划与实际进度同步
- [ ] 风险和对策记录完整

---

## 执行方式

1. **自动检查**：运行以下命令
   ```bash
   pnpm lint          # ESLint 检查
   pnpm typecheck     # 类型检查
   pnpm test:e2e      # E2E 测试
   ```

2. **手动审查**：
   - 阅读最近修改的代码文件
   - 检查上述清单中的每一项
   - 记录发现的问题

3. **生成报告**：
   - 列出发现的问题（按严重程度排序）
   - 提供修复建议
   - 估算修复时间

4. **优先修复**：
   - 🔴 高优先级：安全漏洞、功能 bug
   - 🟡 中优先级：性能问题、用户体验
   - 🟢 低优先级：代码风格、注释

**输出格式**：
```markdown
# 代码审查报告

## 总体评分
- 代码质量: 8/10
- 性能: 9/10
- 安全性: 7/10
- 用户体验: 9/10
- 测试覆盖: 10/10
- 成本控制: 10/10

## 发现的问题

### 🔴 高优先级（必须修复）
1. [安全] JWT 密钥硬编码在代码中
   - 位置: functions/api/auth/login.ts:15
   - 建议: 使用环境变量 `process.env.JWT_SECRET`

### 🟡 中优先级（建议修复）
1. [性能] 新闻列表未使用虚拟滚动
   - 位置: app/components/NewsList.tsx
   - 建议: 使用 react-window 或 @tanstack/react-virtual

### 🟢 低优先级（可选）
1. [代码风格] 部分函数缺少类型注解
   - 位置: app/lib/utils.ts

## 优化建议
...
```
