---
description: 优化性能、成本和用户体验
---

分析并优化项目的三个关键维度：

## 1. 性能优化 ⚡

### 分析当前性能
- 运行 Lighthouse 审计
- 运行 E2E 性能测试
- 检查 Chrome DevTools Performance
- 分析 Network 瀑布图

### 优化目标
- Lighthouse Performance > 90
- 首屏加载时间 < 2s
- API 响应时间 < 500ms
- 交互响应时间 < 100ms

### 优化策略

#### 前端优化
- [ ] **代码分割**：使用动态 import() 按需加载
- [ ] **树摇优化**：移除未使用的代码
- [ ] **图片优化**：WebP 格式、懒加载、响应式图片
- [ ] **字体优化**：font-display: swap、子集化
- [ ] **CSS 优化**：Critical CSS 内联、按需加载
- [ ] **JS 优化**：压缩、去除 console、去除 source map

#### React 优化
- [ ] **组件优化**：React.memo()、useMemo、useCallback
- [ ] **状态优化**：Jotai atoms 拆分、减少不必要的重渲染
- [ ] **列表优化**：虚拟滚动（react-window）
- [ ] **懒加载**：React.lazy() 按需加载组件

#### 网络优化
- [ ] **缓存策略**：Cloudflare KV、浏览器缓存
- [ ] **请求合并**：批量 API 请求
- [ ] **预加载**：关键资源 prefetch/preload
- [ ] **CDN**：静态资源使用 Cloudflare CDN
- [ ] **压缩**：Gzip/Brotli 压缩

#### 数据库优化
- [ ] **索引优化**：为常用查询添加索引
- [ ] **查询优化**：减少 JOIN、使用分页
- [ ] **连接池**：复用数据库连接
- [ ] **缓存层**：Redis/KV 缓存热数据

## 2. 成本优化 💰

### 当前成本分析
检查各服务的使用量和费用：
- Cloudflare Workers 请求数
- Cloudflare D1 读写次数
- Vercel Functions 调用次数
- Claude API 使用量
- 带宽使用量

### 优化目标
- 总运营成本 < ￥200/月
- 充分利用免费额度
- 成本增长可控（线性而非指数）

### 优化策略

#### 计算成本
- [ ] **缓存优化**：延长缓存 TTL（5 分钟 → 15 分钟）
- [ ] **限流保护**：防止恶意请求耗尽配额
- [ ] **按需计算**：避免定时任务，改为按需触发
- [ ] **边缘计算**：使用 Cloudflare Workers（比 Vercel 便宜）

#### 数据库成本
- [ ] **读写优化**：批量操作、减少查询次数
- [ ] **数据清理**：定期清理过期数据（如 30 天前的 magic_tokens）
- [ ] **索引优化**：避免全表扫描

#### AI 成本
- [ ] **模型选择**：Haiku（￥0.003/次）代替 Sonnet（￥0.03/次）
- [ ] **限流控制**：每用户每天最多 5 次 AI 调用
- [ ] **结果缓存**：AI 生成结果缓存 24 小时
- [ ] **批量处理**：合并多个请求减少调用次数

#### 带宽成本
- [ ] **图片压缩**：WebP 格式、适当质量（80%）
- [ ] **代码压缩**：Minify + Gzip/Brotli
- [ ] **CDN 缓存**：静态资源长期缓存

## 3. 用户体验优化 🎨

### 分析用户体验
- 收集用户反馈
- 查看功能需求投票
- 分析用户行为数据
- 测试不同设备和网络

### 优化目标
- 操作流畅（无卡顿）
- 反馈及时（加载状态清晰）
- 布局合理（信息层级清晰）
- 交互友好（符合直觉）

### 优化策略

#### 视觉优化
- [ ] **加载状态**：骨架屏、进度条、Spinner
- [ ] **动画优化**：流畅的过渡动画（60fps）
- [ ] **视觉层级**：重要信息突出显示
- [ ] **配色优化**：蓝色专业主题、对比度达标

#### 交互优化
- [ ] **响应速度**：乐观更新（Optimistic UI）
- [ ] **错误处理**：友好的错误提示、重试机制
- [ ] **操作反馈**：Toast 通知、按钮状态变化
- [ ] **撤销操作**：重要操作可撤销（如投票）

#### 布局优化
- [ ] **响应式设计**：移动端优先、断点设计
- [ ] **信息密度**：避免信息过载
- [ ] **空状态**：空列表友好提示
- [ ] **无限滚动**：加载更多自动触发

#### 无障碍优化
- [ ] **键盘导航**：Tab、Enter、Esc 快捷键
- [ ] **语义化 HTML**：正确使用标签
- [ ] **ARIA 标签**：屏幕阅读器支持
- [ ] **对比度**：文字与背景对比度 > 4.5:1

## 执行流程

1. **测量基准**
   ```bash
   # 运行 Lighthouse
   pnpm lighthouse

   # 运行 E2E 性能测试
   pnpm test:e2e

   # 检查成本
   # 在 Cloudflare/Vercel Dashboard 查看使用量
   ```

2. **识别瓶颈**
   - 分析 Lighthouse 报告
   - 分析 Network 请求
   - 分析成本占比
   - 收集用户反馈

3. **制定方案**
   - 列出优化项（按影响力排序）
   - 估算优化效果（性能提升 %、成本降低 ￥）
   - 估算实施时间

4. **实施优化**
   - 逐项实施（小步迭代）
   - 持续测量效果
   - 回滚无效优化

5. **验证效果**
   - 重新运行 Lighthouse
   - 重新运行 E2E 测试
   - 对比优化前后指标
   - 用户反馈收集

## 输出格式

```markdown
# 优化报告

## 基准测试
- Lighthouse Performance: 75 → **92** (+17)
- 首屏加载时间: 3.2s → **1.8s** (-1.4s)
- API 平均响应时间: 650ms → **320ms** (-330ms)
- 月度成本: ￥180 → **￥45** (-￥135)

## 实施的优化

### 性能优化
1. ✅ 添加 Cloudflare KV 缓存（TTL: 15 分钟）
   - 效果: API 响应时间减少 50%
   - 成本: ￥0（免费额度内）

2. ✅ 图片转换为 WebP 格式
   - 效果: 页面大小减少 40%
   - 成本: ￥0

### 成本优化
1. ✅ AI 调用使用 Haiku 模型
   - 效果: AI 成本降低 90%
   - 影响: 质量略有下降（可接受）

### 用户体验优化
1. ✅ 添加骨架屏加载状态
   - 效果: 用户感知加载时间减少
   - 成本: ￥0

## 后续建议
1. 考虑添加虚拟滚动（数据量大时）
2. 使用 Service Worker 实现离线访问
3. 添加预加载（Prefetch）优化导航
```
